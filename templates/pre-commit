#!/bin/sh
# Pre-commit hook for CodeRabbit CLI review
# This hook runs before each commit to review your changes

echo "üê∞ Running CodeRabbit CLI review on staged changes..."

# Check if coderabbit CLI is available
if ! command -v coderabbit &> /dev/null; then
    echo "‚ö†Ô∏è  CodeRabbit CLI not found!"
    echo ""
    echo "Install it with:"
    echo "  curl -fsSL https://cli.coderabbit.ai/install.sh | sh"
    echo ""
    echo "Or manually from: https://www.coderabbit.ai/docs/cli"
    echo ""
    echo "Skipping CodeRabbit review for now..."
    echo "To enable automatic reviews, install the CLI and commit again."
    exit 0
fi

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit."
    exit 0
fi

echo "Reviewing files:"
echo "$STAGED_FILES" | sed 's/^/  - /'
echo ""

# Run CodeRabbit review on staged files
# The --json flag provides structured output
# You can customize the review behavior here
echo "$STAGED_FILES" | xargs coderabbit review

REVIEW_EXIT_CODE=$?

if [ $REVIEW_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "‚ùå CodeRabbit review found issues!"
    echo ""
    echo "Please review the suggestions above and:"
    echo "  1. Fix the issues and stage your changes again, or"
    echo "  2. Skip this check with: git commit --no-verify"
    echo ""
    exit 1
fi

echo ""
echo "‚úÖ CodeRabbit review passed! Proceeding with commit..."
exit 0
