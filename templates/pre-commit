#!/bin/sh
# Pre-commit hook for CodeRabbit CLI review
# This hook runs before each commit to review your changes

echo "üê∞ Running CodeRabbit CLI review on staged changes..."

# Check if coderabbit CLI is available
if ! command -v coderabbit &> /dev/null; then
    echo "‚ö†Ô∏è  CodeRabbit CLI not found!"
    echo ""
    echo "Install it with:"
    echo "  curl -fsSL https://cli.coderabbit.ai/install.sh | sh"
    echo ""
    echo "Or manually from: https://www.coderabbit.ai/docs/cli"
    echo ""
    echo "Skipping CodeRabbit review for now..."
    echo "To enable automatic reviews, install the CLI and commit again."
    exit 0
fi

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No files staged for commit."
    exit 0
fi

echo "Reviewing files:"
echo "$STAGED_FILES" | sed 's/^/  - /'
echo ""

# Check if CodeRabbit is authenticated
if ! coderabbit auth status 2>/dev/null | grep -q "Logged in"; then
    echo "‚ö†Ô∏è  CodeRabbit not authenticated!"
    echo ""
    echo "Run: coderabbit auth login"
    echo "Then try your commit again."
    echo ""
    echo "Skipping CodeRabbit review for now..."
    exit 0
fi

# Check if this is the first commit (no commit history)
if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
    echo "üìù This appears to be the first commit in this repository."
    echo "   Running CodeRabbit review on all files..."
    echo ""
    # For first commit, review all files instead of uncommitted changes
    if coderabbit review --type all --plain 2>&1; then
        echo ""
        echo "‚úÖ CodeRabbit review passed! Proceeding with initial commit..."
        exit 0
    else
        REVIEW_EXIT_CODE=$?
        echo ""
        echo "‚ùå CodeRabbit review failed with exit code: $REVIEW_EXIT_CODE"
        echo ""
        echo "This could be due to:"
        echo "  ‚Ä¢ CodeRabbit not being properly authenticated"
        echo "  ‚Ä¢ Network connectivity issues"
        echo "  ‚Ä¢ CodeRabbit service being unavailable"
        echo ""
        echo "To troubleshoot:"
        echo "  1. Run: coderabbit auth login"
        echo "  2. Test manually: coderabbit review --type all"
        echo "  3. Check CodeRabbit status: coderabbit auth status"
        echo ""
        echo "To skip this check: git commit --no-verify"
        echo ""
        exit 1
    fi
fi

# Run CodeRabbit review with better error handling
echo "Starting CodeRabbit review..."
if coderabbit review --type uncommitted --plain 2>&1; then
    echo ""
    echo "‚úÖ CodeRabbit review passed! Proceeding with commit..."
    exit 0
else
    REVIEW_EXIT_CODE=$?
    echo ""
    echo "‚ùå CodeRabbit review failed with exit code: $REVIEW_EXIT_CODE"
    echo ""
    echo "This could be due to:"
    echo "  ‚Ä¢ CodeRabbit not being properly authenticated"
    echo "  ‚Ä¢ Network connectivity issues"
    echo "  ‚Ä¢ CodeRabbit service being unavailable"
    echo ""
    echo "To troubleshoot:"
    echo "  1. Run: coderabbit auth login"
    echo "  2. Test manually: coderabbit review --type uncommitted"
    echo "  3. Check CodeRabbit status: coderabbit auth status"
    echo ""
    echo "To skip this check: git commit --no-verify"
    echo ""
    exit 1
fi
